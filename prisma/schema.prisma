// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// Enums
// =============================================

enum Role {
  STUDENT
  ADMIN
  COOPERATIVE
}

enum UserType {
  STUDENT
  GENERAL
}

enum NoticeImportance {
  LOW
  MEDIUM
  HIGH
}

enum InquiryCategory {
  GENERAL
  TECHNICAL
  PAYMENT
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  REFUNDED
  FAILED
}

// =============================================
// User & Authentication
// =============================================

/// 사용자 계정 (학생/관리자/협동조합)
model User {
  id             Int      @id @default(autoincrement())
  userNumber     String   @unique @map("user_number")   // 사용자 고유 번호
  userCode       String   @unique @map("user_code")     // 바코드/QR 코드용 식별자
  userCiNumber   String?  @map("user_ci_number")        // 본인인증 CI 번호
  userName       String   @map("user_name")
  userAddress    String?  @map("user_address")
  userPhone      String?  @map("user_phone")
  userEmail      String   @unique @map("user_email")
  userPassword   String   @map("user_password")          // bcrypt 해시
  userPin        String?  @map("user_pin")               // bcrypt 해시
  userFingerPrint String? @map("user_finger_print")
  userBirthDay   String?  @map("user_birth_day")         // YYYY-MM-DD
  userPoint      Int      @default(0) @map("user_point")
  roles          Role     @default(STUDENT)
  userType       UserType @default(STUDENT) @map("user_type")
  isActive       Boolean  @default(true) @map("is_active")

  // FK: 학생 테이블과 연결 (optional)
  stuNumber      String?  @map("stu_number")
  student        Student? @relation(fields: [stuNumber], references: [stuNumber])

  // Relations
  investments        Investment[]
  chargeLogs         ChargeLog[]
  payLogs            PayLog[]
  inquiries          Inquiry[]
  payments           Payment[]
  passwordResetTokens PasswordResetToken[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

/// 학생 마스터 데이터 (가입 여부와 별개로 관리됨)
model Student {
  id           Int      @id @default(autoincrement())
  stuCode      String   @unique @map("stu_code")
  stuName      String   @map("stu_name")
  stuNumber    String   @unique @map("stu_number")  // 학번
  stuBirth     DateTime @map("stu_birth")            // 생년월일
  stuEmail     String   @unique @map("stu_email")
  isRegistered Boolean  @default(false) @map("is_registered")

  // Relations
  users User[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("students")
}

/// 비밀번호 재설정 토큰
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int      @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime @map("expires_at")
  used      Boolean  @default(false)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("password_reset_tokens")
}

// =============================================
// Investment (출자금)
// =============================================

/// 학생 출자금 정보
model Investment {
  id          Int    @id @default(autoincrement())
  userNumber  String @map("user_number")
  user        User   @relation(fields: [userNumber], references: [userNumber], onDelete: Cascade)
  amount      Int    @default(0)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("investments")
}

// =============================================
// Transaction (거래 로그)
// =============================================

/// 포인트 충전 로그
model ChargeLog {
  id           Int    @id @default(autoincrement())
  userCode     String @map("user_code")
  user         User   @relation(fields: [userCode], references: [userCode], onDelete: Cascade)
  chargedPoint Int    @map("charged_point")
  beforePoint  Int    @map("before_point")
  afterPoint   Int    @map("after_point")
  managedEmail String? @map("managed_email")   // 처리한 관리자 이메일
  reason       String? // 충전 사유

  createdAt DateTime @default(now()) @map("created_at")

  @@map("charge_logs")
}

/// 포인트 결제 로그
model PayLog {
  id          Int    @id @default(autoincrement())
  userCode    String @map("user_code")
  user        User   @relation(fields: [userCode], references: [userCode], onDelete: Cascade)
  payedPoint  Int    @map("payed_point")
  beforePoint Int    @map("before_point")
  afterPoint  Int    @map("after_point")
  eventType   String @map("event_type")   // 결제 이벤트 유형 (상품코드 등)

  createdAt DateTime @default(now()) @map("created_at")

  @@map("pay_logs")
}

// =============================================
// Item (상품)
// =============================================

/// 판매 상품
model Item {
  id              Int    @id @default(autoincrement())
  itemCode        String @unique @map("item_code")
  itemName        String @map("item_name")
  itemPrice       Int    @map("item_price")
  itemCategory    String @map("item_category")
  itemDescription String? @map("item_description")
  isActive        Boolean @default(true) @map("is_active")

  // Relations
  inventories         Inventory[]
  inventorySnapshots  InventorySnapshot[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("items")
}

// =============================================
// Inventory (재고)
// =============================================

/// 기간별 재고 현황
model Inventory {
  id           Int      @id @default(autoincrement())
  itemCode     String   @map("item_code")
  item         Item     @relation(fields: [itemCode], references: [itemCode], onDelete: Cascade)
  itemQuantity Int      @map("item_quantity")
  date         DateTime @db.Date @map("date")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([itemCode, date])
  @@map("inventories")
}

/// 일별 재고 변동 스냅샷
model InventorySnapshot {
  id             Int      @id @default(autoincrement())
  itemCode       String   @map("item_code")
  item           Item     @relation(fields: [itemCode], references: [itemCode], onDelete: Cascade)
  beforeQuantity Int      @map("before_quantity")
  afterQuantity  Int      @map("after_quantity")
  changeQuantity Int      @map("change_quantity")   // afterQuantity - beforeQuantity
  reason         String?
  stdDate        DateTime @db.Date @map("std_date")  // 기준 날짜

  createdAt DateTime @default(now()) @map("created_at")

  @@map("inventory_snapshots")
}

// =============================================
// Notice (공지사항)
// =============================================

/// 공지사항
model Notice {
  id         Int              @id @default(autoincrement())
  title      String
  content    String           @db.Text
  importance NoticeImportance @default(LOW)
  isActive   Boolean          @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notices")
}

// =============================================
// Inquiry (문의)
// =============================================

/// 사용자 문의
model Inquiry {
  id             Int             @id @default(autoincrement())
  userId         Int             @map("user_id")
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  inquiryTitle   String          @map("inquiry_title")
  inquiryContent String          @map("inquiry_content") @db.Text
  inquiryType    InquiryCategory @map("inquiry_type")
  answeredAt     DateTime?       @map("answered_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@map("inquiries")
}

// =============================================
// Payment (PG 결제)
// =============================================

/// PG 결제 정보
model Payment {
  id        Int           @id @default(autoincrement())
  paymentId String        @unique @map("payment_id")  // PG사 결제 ID
  userId    Int           @map("user_id")
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount    Int
  status    PaymentStatus @default(PENDING)
  refundId  String?       @map("refund_id")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payments")
}
